import discord
from discord.ext import commands, tasks
from datetime import datetime, timedelta
from zoneinfo import ZoneInfo  # Python 3.9 ì´ìƒì—ì„œ ì‚¬ìš© ê°€ëŠ¥
import os
import csv
import json
from dotenv import load_dotenv
import matplotlib.pyplot as plt

load_dotenv()

intents = discord.Intents.default()
intents.members = True
intents.message_content = True

bot = commands.Bot(command_prefix='!', intents=intents)

attendance_log = {}
user_data = {}

CSV_FILE = 'study_log.csv'

if not os.path.isfile(CSV_FILE):
    with open(CSV_FILE, 'w', newline='', encoding='utf-8') as f:
        writer = csv.writer(f)
        writer.writerow(['User ID', 'Username', 'Date', 'Start Time', 'End Time', 'Duration (min)'])

@bot.event
async def on_ready():
    print(f'{bot.user} ì‘ë™ ì‹œì‘!')
    encourage_message_loop.start()
    weekly_reset_loop.start()
    daily_study_reminder.start()
    weekly_summary_dm.start()

@bot.event
async def on_member_join(member):
    try:
        await member.send("ì•ˆë…•í•˜ì„¸ìš”! ìº ìŠ¤í„°ë””ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤ ğŸ˜Š\nê³µë¶€ ì‹œê°„ì€ !ì…ì¥ / !í‡´ì¥ ëª…ë ¹ì–´ë¡œ ê¸°ë¡í•˜ì‹¤ ìˆ˜ ìˆì–´ìš”.\nìì„¸í•œ ê±´ ê³µì§€ë¥¼ ì°¸ê³ í•´ì£¼ì„¸ìš”!")
    except discord.Forbidden:
        print(f"{member}ë‹˜ì—ê²Œ DMì„ ë³´ë‚¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")

@bot.command()
async def ì…ì¥(ctx):
    try:
        user = ctx.author
        now = datetime.now(ZoneInfo("Asia/Seoul"))
        attendance_log[user.id] = {"ì…ì¥": now, "ë§ˆì§€ë§‰_ê²©ë ¤": 0}
        await ctx.send(f"{user.mention} ì…ì¥ ì‹œê°„ ê¸°ë¡ ì™„ë£Œ! ğŸŸ¢ {now.strftime('%H:%M:%S')}")
    except Exception as e:
        print("Error in ì…ì¥ command:", e)
        await ctx.send("ì…ì¥ ê¸°ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")

@bot.command()
async def í‡´ì¥(ctx):
    try:
        user = ctx.author
        now = datetime.now(ZoneInfo("Asia/Seoul"))
        uid = user.id

        if uid in attendance_log and "ì…ì¥" in attendance_log[uid]:
            start_time = attendance_log[uid]["ì…ì¥"]
            study_duration = now - start_time
            minutes = int(study_duration.total_seconds() / 60)

            if uid not in user_data:
                user_data[uid] = {"total": 0, "weekly": {}, "daily": {}, "monthly": {}}

            user_data[uid]["total"] += minutes

            today_str = now.date().isoformat()
            month_str = now.strftime("%Y-%m")

            user_data[uid]["weekly"].setdefault(today_str, 0)
            user_data[uid]["weekly"][today_str] += minutes

            user_data[uid]["daily"].setdefault(today_str, 0)
            user_data[uid]["daily"][today_str] += minutes

            user_data[uid]["monthly"].setdefault(month_str, 0)
            user_data[uid]["monthly"][month_str] += minutes

            with open(CSV_FILE, 'a', newline='', encoding='utf-8') as f:
                writer = csv.writer(f)
                writer.writerow([uid, str(user), today_str, start_time.strftime('%H:%M:%S'), now.strftime('%H:%M:%S'), minutes])

            await ctx.send(f"{user.mention} í‡´ì¥ ê¸°ë¡ ì™„ë£Œ! ğŸ”´ ì´ ê³µë¶€ ì‹œê°„: {minutes}ë¶„")
            del attendance_log[uid]
        else:
            await ctx.send("ì…ì¥ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € !ì…ì¥ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.")
    except Exception as e:
        print("Error in í‡´ì¥ command:", e)
        await ctx.send("í‡´ì¥ ê¸°ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")

@bot.command()
async def í†µê³„(ctx, ê¸°ê°„: str = "ì£¼ê°„"):
    try:
        user = ctx.author
        uid = user.id

        if uid not in user_data:
            await ctx.send(f"{user.mention} ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.")
            return

        now = datetime.now(ZoneInfo("Asia/Seoul"))
        if ê¸°ê°„ == "ì¼ê°„":
            today_str = now.date().isoformat()
            daily = user_data[uid].get("daily", {}).get(today_str, 0)
            await ctx.send(f"ğŸ“… ì˜¤ëŠ˜ ê³µë¶€ ì‹œê°„: {daily}ë¶„")
        elif ê¸°ê°„ == "ì›”ê°„":
            month_str = now.strftime("%Y-%m")
            monthly = user_data[uid].get("monthly", {}).get(month_str, 0)
            await ctx.send(f"ğŸ“† ì´ë²ˆ ë‹¬ ê³µë¶€ ì‹œê°„: {monthly}ë¶„")
        else:
            total = user_data[uid].get("total", 0)
            this_week = sum(user_data[uid].get("weekly", {}).values())
            await ctx.send(f"ğŸ“Š {user.display_name}ë‹˜ì˜ ê³µë¶€ í†µê³„\nâ€¢ ì´ ëˆ„ì  ê³µë¶€ ì‹œê°„: {total}ë¶„\nâ€¢ ì´ë²ˆ ì£¼ ê³µë¶€ ì‹œê°„: {this_week}ë¶„")
    except Exception as e:
        print("Error in í†µê³„ command:", e)
        await ctx.send("í†µê³„ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")

@bot.command()
async def ì‹œê°í™”(ctx):
    try:
        uid = ctx.author.id
        if uid not in user_data or "daily" not in user_data[uid]:
            await ctx.send("ê¸°ë¡ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.")
            return

        days = list(user_data[uid]["daily"].keys())
        values = list(user_data[uid]["daily"].values())

        plt.figure(figsize=(10, 4))
        plt.bar(days, values)
        plt.title("ìµœê·¼ ê³µë¶€ ì‹œê°„")
        plt.xlabel("ë‚ ì§œ")
        plt.ylabel("ë¶„")
        plt.xticks(rotation=45)
        plt.tight_layout()
        filename = f"study_chart_{uid}.png"
        plt.savefig(filename)
        plt.close()

        await ctx.author.send(file=discord.File(filename))
        os.remove(filename)
    except Exception as e:
        print("Error in ì‹œê°í™” command:", e)
        await ctx.send("ì‹œê°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")

@bot.command()
async def ë„ì›€ë§(ctx):
    try:
        help_text = (
            "ğŸ“Œ **ìŠ¤í„°ë”” ë´‡ ëª…ë ¹ì–´ ì•ˆë‚´**\n"
            "â€¢ !ì…ì¥ : ê³µë¶€ ì‹œì‘ ì‹œê°„ ê¸°ë¡\n"
            "â€¢ !í‡´ì¥ : ê³µë¶€ ì¢…ë£Œ ë° ì‹œê°„ ê³„ì‚°\n"
            "â€¢ !í†µê³„ : ì´ ê³µë¶€ ì‹œê°„ ë° ì£¼ê°„/ì¼ê°„/ì›”ê°„ í†µê³„ ì¡°íšŒ (!í†µê³„ ì¼ê°„, !í†µê³„ ì›”ê°„)\n"
            "â€¢ !ì‹œê°í™” : ê°œì¸ ê³µë¶€ ì‹œê°„ ê·¸ë˜í”„ ì¶œë ¥ (DMìœ¼ë¡œ ì „ì†¡ë¨)\n"
            "â€¢ í‰ì¼ ì €ë… 8ì‹œ ìë™ ì•Œë¦¼\n"
            "â€¢ í‡´ì¥ ì—†ì´ 6ì‹œê°„ ê²½ê³¼ ì‹œ ìë™ í‡´ì¥ ë° ì•Œë¦¼\n"
            "â€¢ ë§¤ì£¼ í† ìš”ì¼ ì˜¤ì „ 8ì‹œ ì£¼ê°„ ë¦¬í¬íŠ¸ ìë™ DM ë°œì†¡\n"
        )
        await ctx.send(help_text)
    except Exception as e:
        print("Error in ë„ì›€ë§ command:", e)
        await ctx.send("ë„ì›€ë§ ì œê³µ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")

@bot.event
async def on_command_error(ctx, error):
    print(f"Error in command {ctx.command}: {error}")
    await ctx.send("ëª…ë ¹ì–´ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")

@tasks.loop(minutes=10)
async def encourage_message_loop():
    try:
        now = datetime.now(ZoneInfo("Asia/Seoul"))
        today_str = now.date().isoformat()

        to_remove = []
        for uid, log in attendance_log.items():
            start_time = log["ì…ì¥"]
            duration = int((now - start_time).total_seconds() / 60)
            hours = duration // 60

            if hours > log.get("ë§ˆì§€ë§‰_ê²©ë ¤", 0):
                user = await bot.fetch_user(uid)
                try:
                    await user.send(f"ğŸ‰ {hours}ì‹œê°„ ëŒíŒŒ! ê³„ì†í•´ì„œ í˜ë‚´ì„¸ìš”! ğŸ’ª")
                except Exception as e:
                    print(f"Error sending encouragement to {uid}: {e}")
                attendance_log[uid]["ë§ˆì§€ë§‰_ê²©ë ¤"] = hours

            if duration >= 360:
                user = await bot.fetch_user(uid)
                try:
                    await user.send("â° 6ì‹œê°„ì´ ì§€ë‚˜ ìë™ í‡´ì¥ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤. ë‚´ì¼ë„ íŒŒì´íŒ…!")
                except Exception as e:
                    print(f"Error sending auto-logout message to {uid}: {e}")
                to_remove.append(uid)

        for uid in to_remove:
            del attendance_log[uid]
    except Exception as e:
        print("Error in encourage_message_loop:", e)

@tasks.loop(hours=1)
async def weekly_reset_loop():
    try:
        now = datetime.now(ZoneInfo("Asia/Seoul"))
        if now.weekday() == 0 and now.hour == 0:
            backup_name = f"weekly_backup_{now.strftime('%Y-%m-%d')}.json"
            backup_data = {uid: data.get("weekly", {}) for uid, data in user_data.items()}

            with open(backup_name, 'w', encoding='utf-8') as f:
                json.dump(backup_data, f, ensure_ascii=False, indent=2)

            for uid in user_data:
                user_data[uid]["weekly"] = {}

            print("âœ… ì£¼ê°„ ê¸°ë¡ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤. ë°±ì—… ì™„ë£Œ: ", backup_name)
    except Exception as e:
        print("Error in weekly_reset_loop:", e)

@tasks.loop(minutes=1)
async def daily_study_reminder():
    try:
        now = datetime.now(ZoneInfo("Asia/Seoul"))
        if now.weekday() < 5 and now.hour == 20 and now.minute == 0:
            channel = None
            for ch in bot.get_all_channels():
                if (
                    ch.name == 'ì¼ë°˜'
                    and ch.category
                    and ch.category.name == 'ìŠ¤í„°ë”” ì±„ë„'
                    and isinstance(ch, discord.TextChannel)
                ):
                    channel = ch
                    break
            if channel:
                await channel.send("â° ìŠ¤í„°ë”” ì‹œê°„ì…ë‹ˆë‹¤! ì§‘ì¤‘ ëª¨ë“œ ON! ğŸ’»")
            else:
                print("ìŠ¤í„°ë”” ì±„ë„ > ì¼ë°˜ ì±„ë„ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
    except Exception as e:
        print("Error in daily_study_reminder:", e)

@tasks.loop(hours=1)
async def weekly_summary_dm():
    try:
        now = datetime.now(ZoneInfo("Asia/Seoul"))
        if now.weekday() == 5 and now.hour == 8:
            for uid, data in user_data.items():
                user = await bot.fetch_user(uid)
                weekly_sum = sum(data.get("weekly", {}).values())

                days = list(data.get("weekly", {}).keys())
                values = list(data.get("weekly", {}).values())
                if not days:
                    continue

                plt.figure(figsize=(10, 4))
                plt.bar(days, values)
                plt.title("ì´ë²ˆ ì£¼ ê³µë¶€ ì‹œê°„")
                plt.xlabel("ë‚ ì§œ")
                plt.ylabel("ë¶„")
                plt.xticks(rotation=45)
                plt.tight_layout()
                filename = f"weekly_chart_{uid}.png"
                plt.savefig(filename)
                plt.close()

                try:
                    await user.send(f"ğŸ“ˆ ì´ë²ˆ ì£¼ ê³µë¶€ ìš”ì•½\nì´ ê³µë¶€ ì‹œê°„: {weekly_sum}ë¶„", file=discord.File(filename))
                except Exception as e:
                    print(f"Error sending weekly summary to {uid}: {e}")
                os.remove(filename)
    except Exception as e:
        print("Error in weekly_summary_dm:", e)

bot.run(os.getenv("DISCORD_TOKEN"))
